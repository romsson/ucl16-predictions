<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<link href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.css" rel="stylesheet">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">  
  <meta name="description" content="My predictions for the UEFA Champions League #ucl">
  <meta property="og:description" content="Predict the tournament!">
  <meta property="og:image" content="http://predict.re/ucl/ucl.png">
  <meta property="og:url" content="http://predict.re/ucl/">
  <meta property="og:title" content="My predictions for the UEFA Champions League #ucl">

  <title>Predictions for the 2015-2016 UEFA Champions League</title>
  
  <link rel="stylesheet" type="text/css" href="styles.black.css" media="screen" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.js" charset="utf-8"></script>
  <script src="js/dragit.0.1.js" type="text/javascript" charset="utf-8"></script>

  <script src="data.js" type="text/javascript" charset="utf-8"></script>  
  <script src="utils.js" type="text/javascript" charset="utf-8"></script>  

  <link href='http://fonts.googleapis.com/css?family=Merriweather' rel='stylesheet' type='text/css'>
  <link href="http://predict.re/ucl/" rel="canonical" id="new-url">

</head>
<body>

<!--FB code to include after /body -->
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=251461691555585&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<div id="viz">
  <div id="background" style="background-position: left 0px top 0px; width:860px; height:860px; background-size: 850px 800px; background-repeat: no-repeat; position:absolute;"></div>
</div>

<div class="alert alert-success" role="success" style='position: absolute; width: 50%; top:0px; left:25%; display: none'>
<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
  <p style='text-align: center;'><strong>Congratulations!</strong> Your prediction is now 100% complete. <strong><a href="#" onclick="$('#shareModal').modal('show');" style='color: red'>Click here to share it</a></strong>.</p>
</div>

<!-- Main visualization node + background -->


<div style="position:absolute; left:970px; top:50px; width:300px">
  <h1 style="text-align: center"><span style="font-weight:800; text-transform: uppercase;"><span style="font-size:20px">2015/2016</span> <span style="font-size:40px">C</span>hampions <span style="font-size:40px">L</span>eague</span></h1>

  <p style="text-align: center; font-style: italic;">Predict the tournament!</p>

  <br><br><br><br><br>

  <p id="display-completed" style='font-size: 20px; text-align: center; padding-bottom: 0px; margin-right: 10px;'><span style='font-size: 30px; color: black;' >0</span><span id="percentage-completed">0</span>% Complete</p>
  <p style='font-size: 12px; text-align: right; margin-right: 20px;'>(<span id="remaining-teams">32</span> teams remaining)</p>

<!-- Modal details: http://getbootstrap.com/javascript/#modals -->
<div class="modal fade bs-example-modal-lg" id="shareModal" tabindex="-1" role="dialog" aria-labelledby="shareModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <!-- <h4 class="modal-title" id="myModalLabel">Tell us a little bit about you before sharing your prediction..</h4> -->
      </div>
      <div class="modal-body" >

      <iframe id="questionnaireIframe" src="form/index.html" style="width: 100%; height: 600px"></iframe>

      </div>

      <div class="modal-footer">
        <button onclick="$('#shareModal').modal('hide'); $('#shareModalLinks').modal('show'); update_input_location_prediction(); setTimeout(function() { logging('click', 'get-links-modal'); }, 500);" type="button" class="btn btn-default" data-dismiss="modal">I have submitted the questionnaire!</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal details: http://getbootstrap.com/javascript/#modals -->
<div class="modal fade bs-example-modal-lg" id="shareModalLinks" tabindex="-1" role="dialog" aria-labelledby="shareModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <!-- <h4 class="modal-title" id="myModalLabel">Tell us a little bit about you before sharing your prediction..</h4> -->
      </div>
      <div class="modal-body" >

      <h1>Share the link to your current prediction!</h1>

      <br><br>
      <p>Copy and paste the URL below:</p>
      <br>
      <input type="text" id='location_prediction' autofocus></input>
      <br><br>

      <p>..Or click on the social buttons below:</p>
      <br>

      <table width="100%">
      <tr>
      <td>
      <h4>Twitter</h4>
      <div class="twitter-share-container">
        <a href="https://twitter.com/share" class="twitter-share-button" data-via="predictgy" data-url="http://predict.re/ucl/">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
      </div>

        <!-- Place this tag in your head or just before your close body tag. -->
        <script type="text/javascript" src="https://apis.google.com/js/platform.js"></script>

</td><td>
        <h4>Google+</h4>
        <!-- Place this tag where you want the share button to render. -->
        <div class="g-plus" data-action="share" data-annotation="bubble" data-href="http://predict.re/ucl/"></div>
</td><td>
       <h4>Facebook</h4>
        <!-- Social media buttons -->
        <div class="fb-share-button" data-href="http://predict.re/ucl/" data-type="button_count"></div>
</td></tr></table>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="howtoModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h3 class="modal-title" id="myModalLabel">Welcome</h3>
      </div>
      <div class="modal-body" style="height: 500px; overflow-y: auto;">

        <p class='desc'>This website allows you to create your own bracket for the upcoming <b>2015/2016 UEFA Champion's League</b>. Predictions are made easy by <strong>using your mouse to drag and drop</strong> the badge of the teams where you think they will end up.</p>

        <p>How does it work?</p>

        <p class='desc'>It is very simple. Use your mouse to drag and drop the teams where you want them to finish the competition (in the dotted rectangles with question mark within).</p>

        <p style="text-align: center;"><img src="gif/dragdrop.gif" width='400' /></p>

        <p class='desc'>Once you've dragged and dropped teams, you can still change their position in the bracket. Red and green lines respectively show where the teams can be dropped, or not.</p>

        <p style="text-align: center;"><img src="gif/permutations.gif" width='400' /></p>

        <p class='desc'>In case you want to reset the position of a single team, click on its upper right close button.</p>

        <p style="text-align: center;"><img src="gif/closebutton.gif" width='400' /></p>

        <p class='desc'>..Or you can reset all the teams by clicking on the reset button.</p>

        <p style="text-align: center;"><img src="gif/reset.gif" width='400' /></p>

        <p class='desc'>If you are too lazy to finish the bracket, click on the <strong>auto-complete</strong> button.</p>

        <p style="text-align: center;"><img src="gif/autocomplete.gif" width=400 /></p>

        <p>When done, share your prediction to the world!</p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Got it!</button>
      </div>
    </div>
  </div>
</div>

<br><br>

<!-- Reset Modal used to be small bs-example-modal-sm-->
<div class="modal fade bs-example-modal-sm1" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="mySmallModalLabel">Confirmation</h4>
      </div>
      <div class="modal-body">
        <p>If you <strong>reset</strong>, the current prediction will be lost and teams will go back to their initial position.</p>
        <br>
        <p style="text-align: center;"><img src='gif/reset.gif'></p>
        <br>
        <p>Are you sure?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button onclick="$('.bs-example-modal-sm1').modal('hide'); setTimeout(function() { logging('click', 'reset-auto'); reset_tournament(); }, 500);" type="button" class="btn btn-warning">Reset!</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<p style="text-align: center; font-size: 1em; margin-left: 60px;">

<a href="javascript:void(0);" class="button-cta button-cta-blue" data-toggle="modal" data-target="#shareModal" onclick="setTimeout(function() { logging('click', 'share-button'); }, 500);"><i class="fa fa-share"></i> Share<br> this prediction</a>

<br><br><br>

<a href="#" class="button-cta button-cta-orange" data-toggle="modal" data-target=".bs-example-modal-sm1"><i class="fa fa-undo" onclick="setTimeout(function() { logging('click', 'reset-button'); }, 500);"></i> Reset</a>

<br><br><br>

<a href="javascript:void(0);" class="button-cta button-cta-red" data-toggle="modal" data-target="#myModalAutoComplete" onclick="setTimeout(function() { logging('click', 'autocomplete-button'); }, 500);"> <i class="fa fa-magic"></i> Auto-complete</a>

<br><br><br><br><br><br><br><br><br><br><br><br><br>

<a href="javascript:void(0);" class="button-cta" data-toggle="modal" data-target="#howtoModal" onclick="setTimeout(function() { logging('click', 'help-button'); }, 500);"><i class="fa fa-question"></i> Help</a>

</p>

<!-- Auto-Complete Modal -->
<div class="modal fade" id="myModalAutoComplete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Confirmation</h4>
      </div>
      <div class="modal-body">
        <p>If you <strong>auto-complete</strong>, the current prediction will be updated and unassigned teams will have random positions in the bracket.</p>
        <br>
        <p style="text-align: center;"><img src='gif/autocomplete.gif'></p>
        <br>
        <p>Are you sure?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button onclick="$('#myModalAutoComplete').modal('hide'); simulate_tournament(); setTimeout(function() { logging('click', 'autocomplete-modal'); }, 500);" type="button" class="btn btn-success">Auto-Complete!</button>
      </div>
    </div>
  </div>
</div>


<!--
  <p>Drag & Drop its badge along its path in the tournament</p> 

  <p>Created using <a href="https://github.com/romsson/dragit">dragit.js</a>. Graphics and data from <a href="http://www.wikipedia.org/">Wikipedia</a>. Best viewed in <a href="https://www.google.com/chrome/browser/">Google Chrome</a>.</p>
-->

<!--
  <div id="myModal" style="display:none">
    <form> 
      <label>
        <input type="button" name="mode" id="allPaths" value="Show All Paths" onclick="update_paths('SHOW_ALL_PATH')">
        <input type="button" name="mode" id="simulate" value="Simulate Remaining Tournament" onclick="simulate_tournament(true)">
        <input type="button" name="mode" id="simulate" value="Reset" onclick="reset_tournament()"> 
        <input type="button" name="mode" id="simulate" value="Hide rects" onclick="d3.selectAll('rect').style('display', 'none');">
        <input type="button" name="mode" id="simulate" value="Hide text" onclick="d3.selectAll('text').style('display', 'none'); d3.selectAll('.description').style('display', 'block')">
      </label>
    </form>       
  </div>
-->
  <script type="text/javascript">

  var dev = false;
  var uuid = "", ref = "";
  var margin = {top: 50, bottom: 10, left:100, right: 40};
  var w = 950, h = 800;
  var width = w - margin.left - margin.right;
  var height = h - margin.top - margin.bottom;
  var team_width = 40, team_height = 20, game_width = 30, game_height = 20;

  var background_opacity = .6;

  var root =  d3.select("#viz").append("svg:svg").style("position", "absolute")
                .style('overflow', 'visible')
                .attr("width", w)
                .attr("height", height+100);

  var svg = root
                .append("svg:g")
                .attr("transform", "translate("+margin.left+", "+margin.top+")");

  var gPaths = svg.append("g").attr("class", "gPaths");
  var gGroups = svg.append("g").attr("class", "gGroup");
  var gRankings = svg.append("g").attr("class", "gRankings");
  var gDescription = svg.append("g").attr("class", "gDescription");
  var data_groups = data.games.filter(function(d, i) { return i<48 ? d: false; });
  var gBracket = svg.append("g").attr("class", "gBracket");

  var queryString = location.search.substring(1), re = /([^&=]+)=([^&]*)/g;
 
  // Current variables to highlight the paths according to user interactions
  var current_team = "", current_game = "", current_path = -1;
  var current_prediction = decode_url();

  data.teams.map(function(d) { d.nb_games = 0; }); // Counter for group games

  //////////////////////////////////////////////////////////////////
  // Groups (gGroup) ///////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////

  // Filter by group stage games
  data_groups.map(function(d, i) {

    // Append a gGame node. Does not cotain any data
    var gGames = gGroups.append("g")
                        .data([{"game": i}])
                        .attr("id", "game_"+i)
                        .attr("class", "gGame")
                        .attr("transform", function(e) {
                        
                          var group_offset = Math.floor(i/2)%8 * 20;
                          return "translate("+(50*(Math.floor(i/16)))+", "+(20*(i%16*2) + group_offset)+")";
                        });

    // Game number
    gGames.append("svg:text")
          .attr("dx", 17)
          .attr("dy", 15)
          .attr("text-anchor", "middle")
          .text(function(d) { return d.game; })

    // Bind the data (team Home and team Away) to the gGame
    var gTeams = gGames.selectAll(".gTeam")
      .data([{"team": d.home, "type":"home", "score": d.scoreHome, "game": d.id}, 
            {"team": d.away, "type":"away", "score": d.scoreAway, "game": d.id}])
    .enter()
      .append("g").attr("class", "gTeam")
      .attr("id", function(e, j) {
        var team_alias = find_team_alias(e.team);
        var team_data = find_team_data_by_alias(team_alias);
        team_data.nb_games++;
        e.team = team_alias+team_data.nb_games;
        return "game_"+team_alias+team_data.nb_games; 
     })
      .attr("transform", function(e) { return e.type=="home" ? "translate(0, 0)" : "translate(20, 0)"; });

    gTeams.append("svg:rect")
        .attr({"width": game_width-5, "height": game_height, "y":10, "x": 0})
        .attr("class", function(d, i) { return "team"; })
        .style("display", "none") // Simplification purpose

    /*
    gTeams.append("svg:text")
          .attr("dx", game_width/2)
          .attr("dy", 10)
          .attr("text-anchor", function(d) { return d.type=="home" ? "middle": "middle"; })
          .text(function(d) { return d.team; })

    gTeams.append("svg:text")
          .attr("dx", game_width/2-2)
          .attr("dy", game_height)
          .attr("text-anchor", "middle")
          .text(function(d) { return !d.score ? 0: d.score; });
    
    */
    });

    //////////////////////////////////////////////////////////////////
    // Rankings //////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////

    var ranking_data = d3.range(data.teams.length).map(function(d, i) {

      var index_group = Math.floor(i/(data.teams.length/unique_groups.length));
      var e = {};
      e.type = "type";
      e.teams = data.teams.map(function(f, k) { return f.group == unique_groups[index_group] ? 100:0});
      e.team = ((i%(data.teams.length/unique_groups.length)) + 1) + unique_groups[index_group];
      return e;
      
    })

    // Retrieve all the teams
    var team_rankings = gRankings.selectAll(".team")
                            .data(ranking_data)
                          .enter()
                            .append("g")
                            .attr("class", "gGame")
                            .attr("transform", function(d, i) { return "translate(0, -50)"; })
                            .append("g")
                            .attr("class", "gTeam")
                            .attr("id", function(d) { return "game_r"+d.team; })

    create_node_team(team_rankings, 200, 0);

    // ideally should be .call(...)
    function create_node_team(g, x, y, w, h, title) {

      var w = w || game_width, h = h || game_height;
      var shift = 24;

      g.attr("transform", function(d, i) { 

          if(d.team[0] == "4") {
            return "translate(" + (x) + "," + (shift*i+10) + ")";
          } else if(d.team[0] != "1" && d.team[0] != "2") {
            return "translate(" + (x) + "," + shift*i + ")";          
          } else {

            if(d.team[1] == "A" || d.team[1] ==  "B" || d.team[1] == "C") {
              return "translate(" + x + "," + (shift*i-40) + ")"; 
            } else {
               return "translate(" + x + "," + shift*i + ")"; 
            }
          }

      })
      .append("svg:rect")
      .attr({"width": w-5, "height": h-4})
      .style("display", function(d) {
        if(d.team[0] == "1" || d.team[0] == "2")
          return "none";
        else
          return "block";
      })
      //.attr({"y": function(d, i) { return 25*i; }, "x": x})
      .attr("class", function(d, i) { return "team " + d.type; })
      .style("opacity", 1);

      g.append("svg:text")
       // .attr("transform", function(d, i) { return "translate(" + x + "," + 25*i + ")"; })
        .attr({"width": w-5, "height": h-4})
        .attr("text-anchor", function(d) { return d.type=="home" ? "end": "start"; })
        .text(function(d) { return d.team; })

      g.append("svg:text")
            .attr("dx", 10)
            .attr("dy",12)
            .classed('question', true)

            .attr("text-anchor", function(d) { return d.type=="home" ? "end" : "start"; })
            .style('fill', function(d) {
              if(d.team[0] == "1" || d.team[0] == "2") {
                return 'black';
              } else {
                return 'white';
              }
            })
            .text(function(d) {
              if(d.team[0] == "1" || d.team[0] == "2") {
                return '';
              } else {
                return '?';
              }
            })

      // Display howto modal on click
      g.on("click", function() {
        $('#howtoModal').modal('show');
      });

      g.append('title').text(title)

    }

    function create_game_team(game_id, x, y, w, h, text) {

      var gg = gBracket.selectAll("#rgame_"+game_id)
        .data([{"game": game_id, "type":"type", "team": game_id}])
      .enter()
        .append("g")
        .attr("class", "gGame")
        .attr("id", function(d) { return "rgame_"+game_id; })
        .attr("transform", function(d, i) { 
          return "translate("+x+", "+y+")"; 
        })
        .append("g")
        .attr("class", "gTeam")
        .attr("id", function(d) { return "game_"+game_id; })

      create_node_team(gg, 0, 0, w, h, text);

    }

    create_game_team("L49", 400, 430);
    create_game_team("L50", 400, 470);
    create_game_team("L51", 400, 510);
    create_game_team("L52", 400, 550);    
    create_game_team("L53", 400, 590);    
    create_game_team("L54", 400, 630);    
    create_game_team("L55", 400, 670);    
    create_game_team("L56", 400, 710);

    create_game_team("L57", 520, 350);
    create_game_team("L58", 520, 390);
    create_game_team("L59", 520, 430);
    create_game_team("L60", 520, 470);

    create_game_team("L63", 750, 320, 0, 0, "Who is eliminated after the semi-finals?"); // 4th place
    create_game_team("W63", 750, 280, 0, 0, "Who is eliminated after the semi-finals?"); // 3rd place

    create_game_team("L64", 750, 170, 0, 0, "Who lost the final?"); // 2nd place

    // Goal image
    // When hover, shows the paths that make it to the final
    gBracket.append("image")  
        .attr({"x": 690, "y": -30})
        .attr({"width": 150, "height": 100})
        .attr({"xlink:href": "img/goal_black.png" })
        .on("mouseenter", function(d, i) {

           if(dragit.statemachine.current_state != "drag") {
             current_game ="W64";
             update_paths("SHOW_GAME");
           }

        })
        .on("mouseleave", function(d, i) {
  
          if(dragit.statemachine.current_state != "drag") {
            update_paths("ALL_PATHS");
          }

        })
        .on("click", function(d) { 
          logging('click', 'team', {current_team: d.alias, current_game: current_game});
        });

    create_game_team("W64", 750, 120, 0, 0, "Who won the final?")//, 150, 100); // 1s place

    //////////////////////////////////////////////////////////////////
    // Rounds of 16 ///////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////

    create_elimination(48, 56, 300, 50)   // Round of 16
    create_elimination(56, 60, 450, 100)  // Quarter-finals
    create_elimination(60, 62, 580, 120)  // Semi-finals
    create_elimination(62, 64, 700, 120)  // Final games
//    create_elimination(64, 66, 800, 20)


  // Prototype game
/*
  gBracket.append("circle")
          .attr("cx", 715)
          .attr("cy", 220)
          .attr("r", 30)
          .style("fill", "lightgray")
          .style("opacity", .3)

  gBracket.append("circle")
          .attr("cx", 715)
          .attr("cy", 280)
          .attr("r", 30)
          .style("fill", "lightgray")
          .style("opacity", .3)

  gBracket.append("rect")
          .attr("x", 740)
          .attr("y", 535)
          .attr("width", 50)
          .attr("height", 30)
          .style("fill", "white")
          .style("opacity", 1)

  gBracket.append("rect")
          .attr("x", 800)
          .attr("y", 535)
          .attr("width", 50)
          .attr("height", 30)
          .style("fill", "white")
          .style("opacity", 1)
*/


    //////////////////////////////////////////////////////////////////
    // Teams Flags   /////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////
    var place_teams = root.append("g").attr("class", "place_teams");
    var origin_line = place_teams.append("line").attr("class", "origin");
    var scale_teams = d3.scale.linear().domain([0, data.teams.length]).range([0, height-100]);
    var teams = place_teams.append("g").attr("class", "teams");
    var team = teams.selectAll(".gGame")
      .data(data.teams.map(function(d, i) {
        var e = {};
        e.team = d.alias+"0"; //d.team;
        e.group = d.group;
        e.alias = d.alias;
        e.id = i;
        e.x = 0;
        e.y = 0;
        e.t = 0;
        return e;
      }))
    .enter();

    var gTeam = team.append("g").classed('gRoot', true)
        .on("mouseenter", function(d, i) {
          if(dragit.statemachine.current_state != "drag") {
            // TODO: find current path for team
            // current_path
            current_team = d.alias;
            update_paths("SHOW_TEAM");
          }
        })
        .on("mouseleave", function(d, i) { 

          if(dragit.statemachine.current_state != "drag") {
            update_paths();
          }
        })

    team.append("g")
      .attr("class", "gGame")
      .attr("transform", function(d, i) { return "translate(0, 0)"; })
      .append("g")
      .attr("class", "gTeam")
      .attr("transform", function(e, j) { 
        var group_offset = Math.floor(j/4) * 20;
        return "translate(-80, "+ (scale_teams(e.id)-30 + group_offset) +")"; 
      })
      .attr("id", function(d) { return "game_"+d.alias+"0" })

    gTeam.append("rect")
        .filter(function(e, j) { e.x=0; e.y=scale_teams(e.id); return e;} )
        // Not visible
      //  .attr({"width": team_width, "height": team_height})
        .attr({
          "x": function(e, j) { return e.x; }, 
          "y": function(e, j) { var group_offset = Math.floor(j/4) * 20; return e.y + group_offset; }
        }) 
        .attr("class", "team")
        .style("fill", "white")
        .style("opacity", .1)

    // Game placeholder
    gTeam.append("svg:text")
        .attr({"x": function(e, j) { return e.x + 10; }, "y": function(e, j) { var group_offset = Math.floor(j/4) * 20; return e.y + group_offset +10; }}) 
        .attr("dx", 50)
        .attr("dy", 15)
        .attr("stroke", "gray")
        .attr("text-anchor", "left")
        .attr("class", "description team")
        .text(function(d, i) { 
          //return d.team; // Alias
          return  data.teams[i].team; // Full name
        })

        .on("click", function(d) {
          if(test_team_in_prediction(d.alias, current_prediction)) {
            var new_prediction = remove_team_prediction(d.alias, current_prediction);
            display_prediction(new_prediction, current_prediction);
            current_prediction = new_prediction;
            move_team_flag(d.alias, d.alias+"0", 1000, 0, true);
            update_url('close-button');
          }
        })


  // Shadow underneath each flag
  var filters = gTeam.append("defs")
      .append("filter")
      .attr({"id": "fblur", "x": "0", "y": "0", "width": "200%", "height": "200%"})
      filters.append("feOffset").attr({"result": "offOut", "in": "SourceGraphic", "dx": "10", "dy": "10"});
      filters.append("feColorMatrix").attr({"result": "matrixOut", "in": "offOut", "type": "matrix", "values": "0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"})
      filters.append("feGaussianBlur").attr({"result": "blurOut", "in": "matrixOut", "stdDeviation": "10"})
      filters.append("feBlend").attr({"in": "SourceGraphic", "in2": "blurOut", "mode": "normal"})

/* from http://www.w3schools.com/svg/svg_feoffset.asp
    <filter id="f1" x="0" y="0" width="200%" height="200%">
      <feOffset result="offOut" in="SourceGraphic" dx="20" dy="20" />
      <feColorMatrix result = "matrixOut" in = "offOut" type = "matrix" values = "0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"/>
      <feGaussianBlur result="blurOut" in="matrixOut" stdDeviation="10" />
      <feBlend in="SourceGraphic" in2="blurOut" mode="normal" />
    </filter>
  </defs>
*/

  gTeam.append('title').text(function(d) {
    return find_team_data_by_alias(d.alias).team;
  })


  var gFlag = gTeam.append("g")
            .filter(function(e, j) { e.x=0; e.y=0; return e;} )
            .attr("class", function(d, i) { return "gFlag_" + d.alias.toLowerCase(); })
            .attr("transform", function(e, i) { 
              return "translate(" + (-i*100) + ", " + (i*30) + ")"; 
            });


    // Close button
    // http://stackoverflow.com/questions/10019797/pure-css-close-button
    var closeButton = gFlag.append("g")
      .classed('closeButton', true)
      .style('display', 'none')
      .attr('transform', 'translate(5, -5)')
      .on("click", function(d) {

        logging('click', 'close-button', {team: d.alias, game: find_game_team_in_prediction(current_team, current_prediction)[0]});

        reset_team(d.alias, 2000);
        d3.select(this).style('display', 'none');
      })
      .on("mouseenter", function(d, i) {
        d3.selectAll(".close").classed('highlighted', true);

        d3.selectAll('.close').style({'fill': 'red'});

        // Cancel previous transitions
        d3.selectAll(".closeButton").transition();
        d3.select(this).style('display', 'block');  
      })
      .on("mouseleave", function(d, i) {
        d3.select(this).classed('highlighted', false);
        d3.selectAll(".close").style({'fill': 'black'});

        d3.select(this).transition().delay(500).style('display', 'none');
      })

    closeButton.append('title').text('Reset');

    closeButton.append("circle")
      .classed('closeButton', true)
      .attr('cx', 50)
      .attr('cy', 0)
      .attr('id', 'circleCloseButton')
      .attr({"class": "close flag"}) //, "id": function(d) { return "flag2_"+d.alias;}})
      .attr('r', 10)
      .style('fill', 'black')
      .style('stroke-width', 1)
      .style('opacity', 1.5)
      .style('stroke', 'white')

      .on("mouseenter", function(d, i) {
        d3.selectAll(".close").classed('highlighted', true);

      })
      .on("mouseleave", function(d, i) {
        d3.select(this).classed('highlighted', false);
      })

    closeButton.append("line")
      .classed('closeButton', true)
      .attr('x1', 45)
      .attr('x2', 57)
      .attr('y1', -7)
      .attr('y2', 7)
      .style('stroke', 'white')
      .style('stroke-width', 2.5)
      .on("mouseenter", function(d, i) {
        d3.selectAll(".close").classed('highlighted', true);
     
      })
      .on("mouseleave", function(d, i) {
        d3.select(this).classed('highlighted', false);
      })

    closeButton.append("line")
      .classed('closeButton', true)
      .attr('x2', 45)
      .attr('x1', 57)
      .attr('y1', -7)
      .attr('y2', 7)
      .style('stroke', 'white')
      .style('stroke-width', 2.5)
      .on("mouseenter", function(d, i) {
        d3.select(this).classed('highlighted', true);
      })
      .on("mouseleave", function(d, i) {
        d3.select(this).classed('highlighted', false);
      })


  gFlag.append('title').text(function(d) {
    return find_team_data_by_alias(d.alias).team;
  })
/*
    gFlag.append("rect")
      .attr({"x": 17, "y": 7, "height": 15, "width": 25}) 
      .style({"fill": "white"})
      .attr("filter", "url(#fblur)")
*/
    gFlag.append("image")
      //  .attr({"x": function(e, j) { return e.x; }, "y": function(e, j) { var group_offset = Math.floor(j/4) * 20; return e.y + group_offset; }})
        .attr({"x": 0, "y": 0}) 
        .attr({"width": team_width*1.5, "height": team_height*1.5})
        .attr({"xlink:href": function(d, i) { return "teams/"+d.alias.toUpperCase()+".png"; }})
        .attr({"class": "flag", "id": function(d) { return "flag_"+d.alias;}})
        /*
        .on("mouseenter", function(d, i) {

          if(dragit.statemachine.current_state != "drag") {
       //     update_paths("SHOW_TEAM");
     }
        })
        .on("mouseleave", function(d, i) {
          if(dragit.statemachine.current_state != "drag") {
            update_paths("FROM_IMAGE");
          }


        })

        .attr("title", function(d) {return d.alias; })
*/

    // Ghost used for dragging elements
    var gImage =  gTeam.append('g');

    gImage.append("image")
       .filter(function(e, j) { e.x=0; e.y=0; return e;} )
   //     .attr({"x": function(e, j) { return e.x; }, "y": function(e, j) { var group_offset = Math.floor(j/4) * 20; return e.y + group_offset; }}) 
    
        .attr({"x": 0, "y": 0}) 
        .attr({"width": team_width*1.5, "height": team_height*1.5})
        .attr({"xlink:href": function(d, i) { return "teams/"+d.alias.toUpperCase()+".png"; }})
        .attr({"class": "flag", "id": function(d) { return "flag2_"+d.alias;}})
      
        .on("mouseenter", function(d, i) {

         // current_team = d.team.slice(0, 3);
          
          if(dragit.statemachine.current_state != "drag") {

          //  update_paths("SHOW_TEAM");

            // Display all the close buttons
            d3.selectAll('.closeButton')
                      .transition().delay(0)
                      .style('display', 'none');

            // If the team is not in its initial position, then don't show the closeButton
            if(test_team_in_prediction(d.alias, current_prediction)) {
   
              d3.select(d3.select(d3.select(this).node().parentNode).node().parentNode).selectAll('.closeButton')
                .transition().delay(0)
                .style('display', 'block');

            }
          //  d3.select("#background").transition().style("opacity", 0)

          }

        })
        .on("mouseleave", function(d, i) {

          d3.select(d3.select(d3.select(this).node().parentNode).node().parentNode).selectAll('.closeButton')
          .transition().delay(500)
          .style('display', 'none');
/*
          if(dragit.statemachine.current_state != "drag") {
            update_paths("ALL_PATHS");

            d3.select("#background").transition().style("opacity", background_opacity)

          }
*/
        })
        .on("click", function() { })
        .style("opacity", .5)
        .attr("alt", function(d) {return d.alias})
        .on('click', function() {}) // Prevent click
        .call(dragit.object.activate)
        .attr("transform", function(e, i) { 
          return "translate(" + 0 + ", " + (i*25) + ")"; 
        });

    // Each flag should have multiple paths
    dragit.data = all_paths.map(function(d) {
      return d.map(function(d) { 
        var t = get_team_coordinates(d);
        return  t;
      });
    })

    dragit.evt.dragstart.push(function(d) {
      totalDistance = 0;
      lastSeenAt = {x: null, y: null};
    });


    dragit.evt.dragstart.push(function(d) {
      backup_prediction = JSON.parse(JSON.stringify(current_prediction));
      var tmp_game = find_game_team_in_prediction(d.alias, backup_prediction);

      if(tmp_game == 'undefined')
        tmp_game = d.alias + '0';

      logging('drag-start', 'team', {team: d.alias, game: tmp_game});
    })

    // Creates a custom dragit.data object with the positions for the current team
    dragit.evt.dragstart.push(filter_dragit_data_by_team);

    // Store current team in variable
    dragit.evt.dragstart.push(store_current_team);
    dragit.evt.dragstart.push(display_ghost);



//    dragit.evt.dragend.push(reset_highlight_team);
    dragit.evt.drag.push(drag_update);

    // Update the prediction
    dragit.evt.dragend.push(update_flags);
    dragit.evt.dragend.push(function() {
      update_url('drag-end')
    });

    dragit.evt.dragend.push(end_update);
    dragit.evt.dragend.push(update_complete);

    dragit.evt.dragend.push(function(d) {

      var tmp_game = find_game_team_in_prediction(d.alias, current_prediction);

      if(tmp_game == 'undefined')
        tmp_game = d.alias + '0';

      logging('drag-end', 'team', {team: d.alias, game: tmp_game});
    })

    dragit.mouse.dragging = "free";
    dragit.object.offsetX = -100;
    dragit.object.offsetY = -50;

    dragit.object.update = update;

    // Empty teams placeholders
    svg.selectAll(".gTeam")
      .on("mouseenter", function(d, i) {
        
        if(i>=98 && i <=124) {// TO remove if other teams placeholders are activated
        current_game = "r"+d.team;
        } else {
          current_game = d.team;
        }
        
        if(dev) {
          console.log("Current placeholder", current_game, i)
        }

        if(dragit.statemachine.current_state != "drag") {
          update_paths("SHOW_GAME");
        }

      })
      .on("mouseleave", function(d, i) {
        if(dragit.statemachine.current_state != "drag") {
          update_paths("ALL_PATHS");
        }
      });

  //////////////////////////////////////////////////////////////////
  // TITLES Categories /////////////////////////////////////////////
  //////////////////////////////////////////////////////////////////

  gDescription.append("svg:text")
              .attr("dx", 180)
              .attr("dy", -20)
              .attr("text-anchor", "middle")
              .attr("class", "description")
              .text("Groups");

  unique_groups.forEach(function(d, i) {

    gDescription.append("svg:text")
                .attr("dx", 180)
                .attr("dy", 20 + i*100)
                .attr("text-anchor", "middle")
                .attr("class", "description")
                .text(function(e, j) {
                  if(i === 0) {
                    return d;
                  } else {
                    return d;
                  }
                });
  })
/*
  gDescription.append("svg:text")
              .attr("dx", 330)
              .attr("dy", 65)
              .attr("class", "description")
              .attr("text-anchor", "middle")
              .text("Round of 16")

  gDescription.append("svg:text")
              .attr("dx", 470)
              .attr("dy", 150)
              .attr("class", "description")
              .attr("text-anchor", "middle")
              .text("Quarter-Finals")

  gDescription.append("svg:text")
              .attr("dx", 590)
              .attr("dy", 180)
              .attr("class", "description")
              .attr("text-anchor", "middle")
              .text("Semi-Finals")
*/

  gDescription.append("svg:text")
              .attr("dx", 765)
              .attr("dy", 100)
              .attr("class", "description")
              .attr("text-anchor", "middle")
              .text("Winner")

/*
  gDescription.append("svg:text")
              .attr("dx", 765)
              .attr("dy", 110)
              .attr("class", "description")
              .attr("text-anchor", "middle")
              .text("the final?")
*/
  gDescription.append("svg:text")
              .attr("dx", 765)
              .attr("dy", 205)
              .attr("class", "description")
              .attr("text-anchor", "middle")
              .style("font-size", 12)
              .style("font-style", "italic")
              .text("Runner up")

/*
  gDescription.append("svg:text")
              .attr("dx", 810)
              .attr("dy", 295)
              .attr("class", "description")
              .attr("text-anchor", "middle")
              .text("3rd Place")

  gDescription.append("svg:text")
              .attr("dx", 810)
              .attr("dy", 340)
              .attr("class", "description")
              .attr("text-anchor", "middle")
              .text("4th Place")


  gDescription.append("svg:text")
              .attr("dx", 660)
              .attr("dy", 320)
              .attr("class", "description")
              .attr("text-anchor", "middle")
              .text("Eliminated after")
*/
  gDescription.append("svg:text")
              .attr("dx", 765)
              .attr("dy", 355)
              .attr("class", "description")
              .attr("text-anchor", "middle")
              .style("font-size", 12)
              .style("font-style", "italic")
              .text("Semi-Finalists")

  gDescription.append("svg:text")
              .attr("dx", 285)
              .attr("dy", 715)
              .attr("class", "description")
              .attr("text-anchor", "middle")
              .style("font-size", 12)
              .style("font-style", "italic")
              .text("Eliminated after")

  gDescription.append("svg:text")
              .attr("dx", 285)
              .attr("dy", 735)
              .attr("class", "description")
              .attr("text-anchor", "middle")
              .style("font-size", 12)
              .style("font-style", "italic")
              .text("Group Stage")
 
   gDescription.append("svg:text")
              .attr("dx", 490)
              .attr("dy", 625)
              .attr("class", "description")
              .attr("text-anchor", "middle")
              .style("font-size", 12)
              .style("font-style", "italic")
              .text("Eliminated after")

  gDescription.append("svg:text")
              .attr("dx", 490)
              .attr("dy", 645)
              .attr("class", "description")
              .attr("text-anchor", "middle")
              .style("font-size", 12)
              .style("font-style", "italic")
              .text("Round of 16")
 /*
  gDescription.append("svg:text")
              .attr("dx", 610)
              .attr("dy", 425)
              .attr("class", "description")
              .attr("text-anchor", "middle")
              .text("Eliminated after")
*/
  gDescription.append("svg:text")
              .attr("dx", 610)
              .attr("dy", 425)
              .attr("class", "description")
              .style("font-size", 12)
              .style("font-style", "italic")
              .attr("text-anchor", "middle")
              .text("Quarter-Finalists")
 
  d3.selectAll('text').style('display', 'none');
  d3.selectAll('.description').style('display', 'block');
  d3.selectAll('.question').style('display', 'block');

  create_paths();

  // After the page is loaded
  setTimeout(function() {

    // This means there exists a referral
    if(uuid.length > 0) {
      ref = uuid;
    }
    
    // Initi (or reset) UUID 
    uuid = guid();
    update_url('init');

    logging('auto', 'init', {uuid: uuid, ref: ref, current_prediction: current_prediction});

    // If a current selection is in the URL
    if(current_prediction.length) {
      display_prediction(current_prediction, []);
    }

    // TODO: if a uuid, then turn it inot a referral ID

    data.teams.forEach(function(t, i) {

      if(!test_team_in_prediction(t.alias, current_prediction)) {

        // Moving team to their initial vertical
        move_team_flag(t.alias, t.alias + "0", 1000, 0, true);
      }

    })

    // Show the current level of completion
    update_complete(-1);
    updateTwitterValues();

    d3.select("#background")
      .style("background-image", "url('img/background_black.png')")
      .style("opacity", 0)
      .transition().delay(1000).duration(1000)
      .style("opacity", 1)

    document.getElementById('questionnaireIframe').src = "form/index.html?uuid=" + uuid;

    if(!dev) {
      $('#howtoModal').modal('show');
    }
    // Caputre closing window event
    window.onbeforeunload = function() {
     logging('auto', 'close-page', {current_prediction: current_prediction});
    };
    


    $(document).mousemove(function(event) {

      if(dragit.statemachine.current_state == "drag") {

        if(lastSeenAt.x) {
          
          totalDistance += Math.sqrt(Math.pow(lastSeenAt.y - event.clientY, 2) + Math.pow(lastSeenAt.x - event.clientX, 2));
          
          if(totalDistance > 20) {
//            console.log("Total distance", Math.round(totalDistance), current_team, event.clientX, event.clientY);
            logging('dragging', 'team', {team: current_team, x: event.clientX, y:event.clientY})
            totalDistance = 0;
          }

        }

        lastSeenAt.x = event.clientX;
        lastSeenAt.y = event.clientY;

      }
    });

  }, 500);


function update_input_location_prediction() {

  $('#location_prediction').val(location.href);

  setTimeout(function() {
    $('#location_prediction').focus(function() {
      $('#location_prediction').select();
    });
  }, 500);
}

  </script> 
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-67340410-1', 'auto');
    ga('send', 'pageview');

  </script> 
  </body>
</html>
